name: Build APK with Buildozer
on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Clean up disk space early
        run: |
          echo "üßπ –û—á–∏—Å—Ç–∫–∞ –¥–∏—Å–∫–∞..."
          sudo rm -rf /home/runner/actions-runner/_work/_temp/*
          sudo rm -rf ~/.cache/pip
          sudo rm -rf ~/.gradle
          sudo rm -rf ~/.m2
          df -h  # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞



      - name: Install minimal dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
              build-essential \
              python3 python3-pip git \
              openjdk-17-jdk \
              libncurses5-dev libncursesw5-dev \
              autoconf automake libtool \
              pkg-config \
              zlib1g-dev libffi-dev libssl-dev \
              cmake unzip wget
          
          pip3 install --upgrade pip
          pip3 install Cython==0.29.33 buildozer





      - name: Prepare Android SDK
        run: |
          echo "üì± –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Android SDK..."
          export ANDROID_HOME=$HOME/.buildozer/android/platform/android-sdk
          export ANDROID_CMDLINE_TOOLS=$ANDROID_HOME/cmdline-tools/latest
          export JAVA_HOME=/usr/lib/jvm/temurin-17-jdk-amd64
          export PATH=$JAVA_HOME/bin:$PATH

          mkdir -p $HOME/.android && touch $HOME/.android/repositories.cfg
          mkdir -p $ANDROID_HOME/licenses
          echo "8933bad161af4178b1185d1a37fbf41ea5269c55" > $ANDROID_HOME/licenses/android-sdk-license
          echo "d56f5187479451eabf01fb78af6dfcb131a6481e" >> $ANDROID_HOME/licenses/android-sdk-license

          if [ ! -d "$ANDROID_CMDLINE_TOOLS" ]; then
            cd /tmp
            wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O cmdline-tools.zip
            unzip -q cmdline-tools.zip -d cmdline-tools-temp
            mkdir -p $ANDROID_HOME/cmdline-tools/latest
            mv cmdline-tools-temp/cmdline-tools/* $ANDROID_HOME/cmdline-tools/latest/ 2>/dev/null || true
            rm -rf cmdline-tools-temp cmdline-tools.zip
          fi

          # –°–æ–∑–¥–∞—ë–º —Å–∏–º–ª–∏–Ω–∫ tools ‚Üí latest (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
          [ -L "$ANDROID_HOME/tools" ] || ln -sf $ANDROID_HOME/cmdline-tools/latest $ANDROID_HOME/tools

          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ–µ
          yes | $ANDROID_HOME/tools/bin/sdkmanager --sdk_root=$ANDROID_HOME --install "build-tools;34.0.0" "platforms;android-34"
        env:
          JAVA_HOME: /usr/lib/jvm/temurin-17-jdk-amd64

      - name: Clean up before build
        run: |
          echo "üßπ –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –º–µ—Å—Ç–æ..."
          sudo rm -rf /home/runner/actions-runner/_work/_temp/*
          df -h
          
      - name: Fix libtool for LT_SYS_SYMBOL_USCORE
        run: |
          echo "üîß –ò—Å–ø—Ä–∞–≤–ª—è–µ–º libtool –∏ aclocal –¥–ª—è LT_SYS_SYMBOL_USCORE..."

          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º/–ø–µ—Ä–µ—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º libtool
          sudo apt-get install -y --reinstall libtool libtool-bin automake autoconf

          # –û–±–Ω–æ–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø—É—Ç–∏ aclocal
          sudo mkdir -p /usr/share/aclocal
          sudo cp /usr/share/libtool/build-aux/ltmain.sh /usr/share/libtool/m4/*.m4 /usr/share/aclocal/ 2>/dev/null || true

          # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º aclocal
          sudo aclocal --system-acdir=/usr/share/aclocal -I /usr/share/aclocal || true

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º–∞–∫—Ä–æ—Å –µ—Å—Ç—å
          if aclocal -Wnone --verbose -I /usr/share/aclocal 2>&1 | grep -q LT_SYS_SYMBOL_USCORE; then
            echo "‚úÖ LT_SYS_SYMBOL_USCORE –Ω–∞–π–¥–µ–Ω –≤ aclocal"
          else
            echo "‚ö†Ô∏è LT_SYS_SYMBOL_USCORE –Ω–µ –Ω–∞–π–¥–µ–Ω, –∫–æ–ø–∏—Ä—É–µ–º –≤—Ä—É—á–Ω—É—é..."
            # –†–µ–∑–µ—Ä–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç: –∏—â–µ–º –≤ —Å–∏—Å—Ç–µ–º–µ –∏ –∫–æ–ø–∏—Ä—É–µ–º
            LIBTOOL_M4=$(find /usr -name libtool.m4 -o -name lt~obsolete.m4 2>/dev/null | head -n 1)
            if [ -f "$LIBTOOL_M4" ]; then
              sudo cp "$LIBTOOL_M4" /usr/share/aclocal/ || true
            fi
          fi

          echo "‚úÖ –ì–æ—Ç–æ–≤–æ: libtool –∏ aclocal –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã"



      - name: Fix libffi header path
        run: |
          echo "üîß –°–æ–∑–¥–∞—ë–º —Å–∏–º–ª–∏–Ω–∫ –¥–ª—è ffi.h..."
          sudo mkdir -p /usr/include/ffi
          sudo ln -sf /usr/include/x86_64-linux-gnu/ffi.h /usr/include/ffi/ffi.h
          sudo ln -sf /usr/lib/x86_64-linux-gnu/libffi.so /usr/lib/libffi.so
          ls /usr/include/ffi/ffi.h && echo "‚úÖ –ì–æ—Ç–æ–≤–æ"


      - name: Build APK
        run: |
          # –£–¥–∞–ª—è–µ–º .buildozer, –µ—Å–ª–∏ –æ—Å—Ç–∞–ª—Å—è –æ—Ç –ø—Ä–æ—à–ª—ã—Ö –∑–∞–ø—É—Å–∫–æ–≤
          rm -rf .buildozer
          # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä–∫—É ‚Äî –æ–Ω–∞ —Å–∞–º–∞ —Å–∫–∞—á–∞–µ—Ç p4a
          buildozer -v android debug




      - name: Upload APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: app-apk
          path: bin/*.apk
          retention-days: 7
