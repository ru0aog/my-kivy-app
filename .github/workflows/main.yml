name: Build APK with Buildozer
on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Clean up disk space early
        run: |
          echo "üßπ –û—á–∏—Å—Ç–∫–∞ –¥–∏—Å–∫–∞..."
          sudo rm -rf /home/runner/actions-runner/_work/_temp/*
          sudo rm -rf ~/.cache/pip
          sudo rm -rf ~/.gradle
          sudo rm -rf ~/.m2
          df -h  # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞



      - name: Install minimal dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
              build-essential \
              python3 python3-pip git \
              openjdk-17-jdk \
              libncurses5-dev libncursesw5-dev \
              autoconf automake libtool \
              pkg-config \
              zlib1g-dev libffi-dev libssl-dev \
              cmake unzip wget
          
          pip3 install --upgrade pip
          pip3 install Cython==0.29.33 buildozer





      - name: Prepare Android SDK
        run: |
          echo "üì± –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Android SDK..."
          export ANDROID_HOME=$HOME/.buildozer/android/platform/android-sdk
          export ANDROID_CMDLINE_TOOLS=$ANDROID_HOME/cmdline-tools/latest
          export JAVA_HOME=/usr/lib/jvm/temurin-17-jdk-amd64
          export PATH=$JAVA_HOME/bin:$PATH

          mkdir -p $HOME/.android && touch $HOME/.android/repositories.cfg
          mkdir -p $ANDROID_HOME/licenses
          echo "8933bad161af4178b1185d1a37fbf41ea5269c55" > $ANDROID_HOME/licenses/android-sdk-license
          echo "d56f5187479451eabf01fb78af6dfcb131a6481e" >> $ANDROID_HOME/licenses/android-sdk-license

          if [ ! -d "$ANDROID_CMDLINE_TOOLS" ]; then
            cd /tmp
            wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O cmdline-tools.zip
            unzip -q cmdline-tools.zip -d cmdline-tools-temp
            mkdir -p $ANDROID_HOME/cmdline-tools/latest
            mv cmdline-tools-temp/cmdline-tools/* $ANDROID_HOME/cmdline-tools/latest/ 2>/dev/null || true
            rm -rf cmdline-tools-temp cmdline-tools.zip
          fi

          # –°–æ–∑–¥–∞—ë–º —Å–∏–º–ª–∏–Ω–∫ tools ‚Üí latest (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
          [ -L "$ANDROID_HOME/tools" ] || ln -sf $ANDROID_HOME/cmdline-tools/latest $ANDROID_HOME/tools

          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ–µ
          yes | $ANDROID_HOME/tools/bin/sdkmanager --sdk_root=$ANDROID_HOME --install "build-tools;34.0.0" "platforms;android-34"
        env:
          JAVA_HOME: /usr/lib/jvm/temurin-17-jdk-amd64

      - name: Clean up before build
        run: |
          echo "üßπ –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –º–µ—Å—Ç–æ..."
          sudo rm -rf /home/runner/actions-runner/_work/_temp/*
          df -h
          
      - name: Patch libffi to fix LT_SYS_SYMBOL_USCORE
        run: |
          echo "üîß –ü–∞—Ç—á–∏–º libffi: –∫–æ–ø–∏—Ä—É–µ–º libtool.m4 –≤—Ä—É—á–Ω—É—é..."

          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º libtool –∏ –∏—â–µ–º –Ω—É–∂–Ω—ã–µ .m4 —Ñ–∞–π–ª—ã
          sudo apt-get install -y libtool libtool-bin

          # –ù–∞—Ö–æ–¥–∏–º —Ñ–∞–π–ª—ã libtool
          LIBTOOL_M4=$(find /usr/share/aclocal -name libtool.m4 | head -n 1)
          LT_OBSOLETE_M4=$(find /usr/share/aclocal -name lt~obsolete.m4 | head -n 1)

          if [ ! -f "$LIBTOOL_M4" ]; then
            echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω libtool.m4"
            exit 1
          fi

          if [ ! -f "$LT_OBSOLETE_M4" ]; then
            echo "‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω lt~obsolete.m4 ‚Äî –ø–æ–ø—Ä–æ–±—É–µ–º —Å–æ–∑–¥–∞—Ç—å –ø—É—Å—Ç–æ–π"
            sudo touch /tmp/lt~obsolete.m4
            LT_OBSOLETE_M4=/tmp/lt~obsolete.m4
          fi

          # –£–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Ç—å, –∫—É–¥–∞ p4a —Å–∫–∞—á–∏–≤–∞–µ—Ç libffi
          LIBFFI_BUILD_DIR="$HOME/.buildozer/android/platform/build-arm64-v8a/build/bootstrap_builds/sdl2-python3/ffi"

          # –°–æ–∑–¥–∞—ë–º –ø–∞–ø–∫—É m4, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
          mkdir -p "$LIBFFI_BUILD_DIR/m4"

          # –ö–æ–ø–∏—Ä—É–µ–º –º–∞–∫—Ä–æ—Å—ã
          cp "$LIBTOOL_M4" "$LIBFFI_BUILD_DIR/m4/"
          cp "$LT_OBSOLETE_M4" "$LIBFFI_BUILD_DIR/m4/"

          echo "‚úÖ libtool.m4 –∏ lt~obsolete.m4 —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ $LIBFFI_BUILD_DIR/m4/"

          # –ü—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ —Ñ–∞–π–ª—ã –µ—Å—Ç—å
          ls -la "$LIBFFI_BUILD_DIR/m4/"




      - name: Fix libffi header path
        run: |
          echo "üîß –°–æ–∑–¥–∞—ë–º —Å–∏–º–ª–∏–Ω–∫ –¥–ª—è ffi.h..."
          sudo mkdir -p /usr/include/ffi
          sudo ln -sf /usr/include/x86_64-linux-gnu/ffi.h /usr/include/ffi/ffi.h
          sudo ln -sf /usr/lib/x86_64-linux-gnu/libffi.so /usr/lib/libffi.so
          ls /usr/include/ffi/ffi.h && echo "‚úÖ –ì–æ—Ç–æ–≤–æ"

      - name: Build APK
        run: |
          echo "üîÑ –ó–∞–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä–∫—É APK..."

          # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π .buildozer
          rm -rf .buildozer

          # –®–∞–≥ 1: –ó–∞–ø—É—Å–∫–∞–µ–º update ‚Äî —á—Ç–æ–±—ã —Å–∫–∞—á–∞—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
          echo "üì• –°–∫–∞—á–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ buildozer android update..."
          buildozer android update

          # –®–∞–≥ 2: –ù–∞—Ö–æ–¥–∏–º –ø—É—Ç—å –∫ —Å–±–æ—Ä–∫–µ libffi
          LIBFFI_BUILD_DIR="$HOME/.buildozer/android/platform/build-arm64-v8a/build/bootstrap_builds/sdl2-python3/ffi"

          if [ ! -d "$LIBFFI_BUILD_DIR" ]; then
            echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –ø–∞–ø–∫–∞ libffi: $LIBFFI_BUILD_DIR"
            echo "üîç –ü—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ –µ—Å—Ç—å –≤ build/bootstrap_builds..."
            find $HOME/.buildozer/android/platform/build-arm64-v8a/build/bootstrap_builds -type d -name "ffi" || true
            exit 1
          fi

          echo "üîß –ü–∞—Ç—á–∏–º libffi: –∫–æ–ø–∏—Ä—É–µ–º libtool.m4 –∏ lt~obsolete.m4..."

          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º libtool
          sudo apt-get install -y libtool libtool-bin

          # –ù–∞—Ö–æ–¥–∏–º —Ñ–∞–π–ª—ã
          LIBTOOL_M4=$(find /usr/share/aclocal -name libtool.m4 | head -n 1)
          LT_OBSOLETE_M4=$(find /usr/share/aclocal -name lt~obsolete.m4 | head -n 1)

          if [ ! -f "$LIBTOOL_M4" ]; then
            echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω libtool.m4"
            exit 1
          fi

          if [ ! -f "$LT_OBSOLETE_M4" ]; then
            echo "‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω lt~obsolete.m4 ‚Äî —Å–æ–∑–¥–∞—ë–º –ø—É—Å—Ç–æ–π"
            LT_OBSOLETE_M4=/tmp/lt~obsolete.m4
            touch "$LT_OBSOLETE_M4"
          fi

          # –°–æ–∑–¥–∞—ë–º m4/ –∏ –∫–æ–ø–∏—Ä—É–µ–º
          mkdir -p "$LIBFFI_BUILD_DIR/m4"
          cp "$LIBTOOL_M4" "$LIBFFI_BUILD_DIR/m4/"
          cp "$LT_OBSOLETE_M4" "$LIBFFI_BUILD_DIR/m4/"

          echo "‚úÖ –ú–∞–∫—Ä–æ—Å—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ $LIBFFI_BUILD_DIR/m4/"
          ls -la "$LIBFFI_BUILD_DIR/m4/"

          # –®–∞–≥ 3: –ó–∞–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä–∫—É
          echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä–∫—É APK..."
          buildozer -v android debug





      - name: Upload APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: app-apk
          path: bin/*.apk
          retention-days: 7
